parameters:
  vmImage: ''
  serviceConnection: ''
  subscriptionId: ''
  resourceGroupName: ''
  environmentName: ''

jobs:
- job: Teardown
  displayName: Teardown ${{ upper(parameters.environmentName) }}
  pool:
    vmImage: "${{ parameters.vmImage }}"
  steps:
  - checkout: self
  - task: AzurePowerShell@5
    displayName: Teardown environment
    inputs:
      azureSubscription: $(serviceConnection)
      azurePowerShellVersion: 'Latest'
      ScriptType: 'InlineScript'
      Inline: |
        # load module
        . $(baseWorkingDirectory)/internal/scripts/preimport.ps1 && . $(baseWorkingDirectory)/tests/Pester.ps1

        Invoke-ARMDeployment -Scope "subscription" -ResourceGroupName ${{ parameters.resourceGroupName }} -SubscriptionId $(subscriptionId) -TeardownEnvironment
